# gtfs

This is a Go package for parsing GTFS static and realtime feeds.

The static parser is pretty straightforward and simply maps fields in the
GTFS static CSV files to associated Go types.

For realtime parsing this package offers two options.
Option 1 is to use the parser and types generated by the protobuf compiler which are available in the `proto` subpackage.
This saves you from having to compile the protobufs yourself.

Option 2 is to use the package's custom parser, which takes the protobuf output from option 1,
does a bunch of post-processing, and then outputs the result in standard (non-proto) Go types.
This post-processing does useful things like:

- Converts some data fields to more idiomatic Go types - for example, times are converted from `int64` Unix timestamps to `time.Time` values.

- Makes the representation of trips and vehicles more explicit.
  Each trip has a (nullable) pointer to the associated vehicle in the feed, if it exists, and vice-versa.

- Implements business logic to map data in various GTFS realtime extensions to regular GTFS realtime fields.

**Backwards compatibility warning**:
this package is under active development and backwards incompatible changes are frequently made.
We're eventually planning to release a `v1.0.0` version, and after that all changes
will be backwards compatible and consistent with semantic versioning.

## Examples

Parse the GTFS static feed for the New York City Subway:

```go
resp, _ := http.Get("http://web.mta.info/developers/data/nyct/subway/google_transit.zip")
b, _ := io.ReadAll(resp.Body)
staticData, _ := gtfs.ParseStatic(b, gtfs.ParseStaticOptions{})
fmt.Printf("The New York City subway has %d routes and %d stations\n", len(staticData.Routes), len(staticData.Stops))
```

Parse the GTFS realtime feed for the San Francisco Bay Area BART:

```go
resp, _ := http.Get("http://api.bart.gov/gtfsrt/tripupdate.aspx")
b, _ := io.ReadAll(resp.Body)
realtimeData, _ := gtfs.ParseRealtime(b, &gtfs.ParseRealtimeOptions{})
fmt.Printf("The SF BART currently has %d trains running or scheduled\n", len(realtimeData.Trips))
```

## Supported GTFS Schedule files

Below is a list of the GTFS schedule files and whether they are currently supported. Progress for full support is being tracked in issue [#4](https://github.com/jamespfennell/gtfs/issues/4).

| File Name                                                                                              | Supported | Required by Spec        | Notes                                                       |
| ------------------------------------------------------------------------------------------------------ | --------- | ----------------------- | ----------------------------------------------------------- |
| [agency.txt](https://gtfs.org/documentation/schedule/reference/#agencytxt)                             | ✅        | Required                |                                                             |
| [stops.txt](https://gtfs.org/documentation/schedule/reference/#stopstxt)                               | ✅        | Conditionally Required  | Always required by library                                  |
| [routes.txt](https://gtfs.org/documentation/schedule/reference/#routestxt)                             | ✅        | Required                |                                                             |
| [trips.txt](https://gtfs.org/documentation/schedule/reference/#tripstxt)                               | ✅        | Required                |                                                             |
| [stop_times.txt](https://gtfs.org/documentation/schedule/reference/#stop_timestxt)                     | ✅        | Required                |                                                             |
| [calendar.txt](https://gtfs.org/documentation/schedule/reference/#calendartxt)                         | ✅        | Conditionally Required  | Surfaced as a `Service`, always required by library         |
| [calendar_dates.txt](https://gtfs.org/documentation/schedule/reference/#calendar_datestxt)             | ✅        | Conditionally Required  | Surfaced as part of a `Service`, always required by library |
| [fare_attributes.txt](https://gtfs.org/documentation/schedule/reference/#fare_attributestxt)           | ✅        | Optional                |                                                             |
| [fare_rules.txt](https://gtfs.org/documentation/schedule/reference/#fare_rulestxt)                     | ✅        | Optional                |                                                             |
| [timeframes.txt](https://gtfs.org/documentation/schedule/reference/#timeframestxt)                     | ❌        | Optional                |                                                             |
| [fare_media.txt](https://gtfs.org/documentation/schedule/reference/#fare_mediatxt)                     | ❌        | Optional                |                                                             |
| [fare_products.txt](https://gtfs.org/documentation/schedule/reference/#fare_productstxt)               | ❌        | Optional                |                                                             |
| [fare_leg_rules.txt](https://gtfs.org/documentation/schedule/reference/#fare_leg_rulestxt)             | ❌        | Optional                |                                                             |
| [fare_leg_join_rules.txt](https://gtfs.org/documentation/schedule/reference/#fare_leg_join_rulestxt)   | ❌        | Optional                |                                                             |
| [fare_transfer_rules.txt](https://gtfs.org/documentation/schedule/reference/#fare_transfer_rulestxt)   | ❌        | Optional                |                                                             |
| [areas.txt](https://gtfs.org/documentation/schedule/reference/#areastxt)                               | ❌        | Optional                |                                                             |
| [stop_areas.txt](https://gtfs.org/documentation/schedule/reference/#stop_areastxt)                     | ❌        | Optional                |                                                             |
| [networks.txt](https://gtfs.org/documentation/schedule/reference/#networkstxt)                         | ❌        | Conditionally Forbidden |                                                             |
| [route_networks.txt](https://gtfs.org/documentation/schedule/reference/#route_networkstxt)             | ❌        | Conditionally Forbidden |                                                             |
| [location_groups.txt](https://gtfs.org/documentation/schedule/reference/#location_groupstxt)           | ❌        | Conditionally Forbidden |                                                             |
| [shapes.txt](https://gtfs.org/documentation/schedule/reference/#shapestxt)                             | ✅        | Optional                |                                                             |
| [frequencies.txt](https://gtfs.org/documentation/schedule/reference/#frequenciestxt)                   | ✅        | Optional                |                                                             |
| [transfers.txt](https://gtfs.org/documentation/schedule/reference/#transferstxt)                       | ✅        | Optional                |                                                             |
| [pathways.txt](https://gtfs.org/documentation/schedule/reference/#pathwaystxt)                         | ❌        | Optional                |                                                             |
| [levels.txt](https://gtfs.org/documentation/schedule/reference/#levelstxt)                             | ❌        | Conditionally Required  |                                                             |
| [location_group_stops.txt](https://gtfs.org/documentation/schedule/reference/#location_group_stopstxt) | ❌        | Optional                |                                                             |
| [locations.geojson](https://gtfs.org/documentation/schedule/reference/#locationsgeojson)               | ❌        | Optional                |                                                             |
| [booking_rules.txt](https://gtfs.org/documentation/schedule/reference/#booking_rulestxt)               | ❌        | Optional                |                                                             |
| [translations.txt](https://gtfs.org/documentation/schedule/reference/#translationstxt)                 | ❌        | Optional                |                                                             |
| [feed_info.txt](https://gtfs.org/documentation/schedule/reference/#feed_infotxt)                       | ❌        | Conditionally Required  |                                                             |
| [attributions.txt](https://gtfs.org/documentation/schedule/reference/#attributionstxt)                 | ❌        | Optional                |                                                             |

## Performance

The package is designed to be about as fast as possible without resorting to unreadable code.
A profiler for the package is in the `performance` directory.

### Static parser

The static parser has been performance optimized somewhat significantly.
It takes about 3 seconds to parse the GTFS static data for the NYC buses (45 megabytes compressed, 360 megabytes uncompressed).
The rough breakdown is:

- 30% of the time unzipping the archives (using the `archive/zip` standard library package).

- 40% of the time parsing the CSV files into strings (using the `encoding/csv` standard library package)

- 30% of the time in this package performing the conversions from strings into types like `time.Duration`
  and linking related entities.

### Realtime parser

TBD
